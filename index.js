require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { OpenAI } = require('openai');

const app = express();
const openai = new OpenAI({
  apiKey: process.env.GROQ_API_KEY,
  baseURL: 'https://api.groq.com/openai/v1',
});

app.use(cors({ origin: '*', methods: ['GET', 'POST', 'OPTIONS'], allowedHeaders: ['Content-Type'] }));
app.options('/webhook', (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  res.sendStatus(200);
});
app.use(express.json());

const LANGUAGE_SYSTEM_PROMPTS = {
  en: 'You are a smart assistant for Indian farmers. Reply in friendly and simple English with helpful, practical advice.',
  hi: 'à¤†à¤ª à¤à¤• à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤•à¤¿à¤¸à¤¾à¤¨à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥ˆà¤‚à¥¤ à¤¹à¤®à¥‡à¤¶à¤¾ à¤®à¤¿à¤¤à¥à¤°à¤µà¤¤ à¤”à¤° à¤¸à¤°à¤² à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥‡à¤‚à¥¤ à¤µà¥à¤¯à¤¾à¤µà¤¹à¤¾à¤°à¤¿à¤• à¤¸à¤²à¤¾à¤¹ à¤¦à¥‡à¤‚à¥¤',
  kn: 'à²¨à³€à²µà³ à²­à²¾à²°à²¤à³€à²¯ à²°à³ˆà²¤à²°à²¿à²—à³† à²¬à³à²¦à³à²§à²¿à²µà²‚à²¤ à²¸à²¹à²¾à²¯à²•. à²¸à²¦à²¾ à²¸à³à²¨à³‡à²¹à²ªà³‚à²°à²¿à²¤ à²®à²¤à³à²¤à³ à²¸à²°à²³ à²•à²¨à³à²¨à²¡à²¦à²²à³à²²à²¿ à²ªà³à²°à²¤à²¿à²¸à³à²ªà²‚à²¦à²¿à²¸à²¿.',
  ta: 'à®¨à¯€à®™à¯à®•à®³à¯ à®‡à®¨à¯à®¤à®¿à®¯ à®µà®¿à®µà®šà®¾à®¯à®¿à®•à®³à¯à®•à¯à®•à®¾à®© à®ªà¯à®¤à¯à®¤à®¿à®šà®¾à®²à®¿ à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯. à®Žà®ªà¯à®ªà¯‹à®¤à¯à®®à¯ à®¨à®Ÿà¯à®ªà®¾à®© à®®à®±à¯à®±à¯à®®à¯ à®Žà®³à®¿à®¯ à®¤à®®à®¿à®´à®¿à®²à¯ à®ªà®¤à®¿à®²à®³à®¿à®•à¯à®•à®µà¯à®®à¯.',
  te: 'à°®à±€à°°à± à°­à°¾à°°à°¤à±€à°¯ à°°à±ˆà°¤à±à°²à°•à± à°¤à±†à°²à°¿à°µà±ˆà°¨ à°¸à°¹à°¾à°¯à°•à±à°¡à±. à°Žà°ªà±à°ªà±à°¡à±‚ à°¸à±à°¨à±‡à°¹à°ªà±‚à°°à±à°µà°•à°®à±ˆà°¨ à°®à°°à°¿à°¯à± à°¸à°°à°³à°®à±ˆà°¨ à°¤à±†à°²à±à°—à± à°²à±‹ à°¸à±à°ªà°‚à°¦à°¿à°‚à°šà°‚à°¡à°¿.',
  ml: 'à´¨à´¿à´™àµà´™à´³àµâ€ à´‡à´¨àµà´¤àµà´¯à´¨àµâ€ à´•à´°àµâ€à´·à´•à´°àµâ€à´•àµà´•à´¾à´¯àµà´³àµà´³ à´¸àµà´®à´¾à´°àµâ€à´Ÿàµà´Ÿàµ à´…à´¸à´¿à´¸àµà´±àµà´±à´¨àµà´±à´¾à´£àµ. à´Žà´ªàµà´ªàµ‹à´´àµà´‚ à´¸àµà´¹àµƒà´¦à´¾à´¯àµà´‚ à´²à´³à´¿à´¤à´µàµà´®à´¾à´¯ à´®à´²à´¯à´¾à´³à´¤àµà´¤à´¿à´²àµâ€ à´ªàµà´°à´¤à´¿à´•à´°à´¿à´•àµà´•àµà´•.',
  pa: 'à¨¤à©à¨¸à©€à¨‚ à¨­à¨¾à¨°à¨¤à©€ à¨•à¨¿à¨¸à¨¾à¨¨à¨¾à¨‚ à¨²à¨ˆ à¨¸à¨®à¨¾à¨°à¨Ÿ à¨¸à¨¹à¨¾à¨‡à¨• à¨¹à©‹à¥¤ à¨¹à¨®à©‡à¨¸à¨¼à¨¾à¨‚ à¨¦à©‹à¨¸à¨¤à¨¾à¨¨à¨¾ à¨…à¨¤à©‡ à¨¸à¨§à¨¾à¨°à¨¨ à¨ªà©°à¨œà¨¾à¨¬à©€ à¨µà¨¿à©±à¨š à¨œà¨µà¨¾à¨¬ à¨¦à¨¿à¨“à¥¤',
  mr: 'à¤¤à¥à¤®à¥à¤¹à¥€ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¶à¥‡à¤¤à¤•à¤±à¥à¤¯à¤¾à¤‚à¤¸à¤¾à¤ à¥€ à¤à¤• à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤¸à¤¹à¤¾à¤¯à¥à¤¯à¤• à¤†à¤¹à¤¾à¤¤. à¤¨à¥‡à¤¹à¤®à¥€à¤š à¤®à¥ˆà¤¤à¥à¤°à¥€à¤ªà¥‚à¤°à¥à¤£ à¤†à¤£à¤¿ à¤¸à¥‹à¤ªà¥à¤¯à¤¾ à¤®à¤°à¤¾à¤ à¥€à¤¤ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥à¤¯à¤¾.',
  bn: 'à¦†à¦ªà¦¨à¦¿ à¦­à¦¾à¦°à¦¤à§€à¦¯à¦¼ à¦•à§ƒà¦·à¦•à¦¦à§‡à¦° à¦œà¦¨à§à¦¯ à¦à¦•à¦Ÿà¦¿ à¦¸à§à¦®à¦¾à¦°à§à¦Ÿ à¦¸à¦¹à¦¾à¦¯à¦¼à¦•à¥¤ à¦¸à¦°à§à¦¬à¦¦à¦¾ à¦¬à¦¨à§à¦§à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£ à¦à¦¬à¦‚ à¦¸à¦¹à¦œ à¦¬à¦¾à¦‚à¦²à¦¾à¦¯à¦¼ à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¨à¥¤',
  gu: 'àª¤àª®à«‡ àª­àª¾àª°àª¤à«€àª¯ àª–à«‡àª¡à«àª¤à«‹ àª®àª¾àªŸà«‡ àªàª• àª¸à«àª®àª¾àª°à«àªŸ àª¸àª¹àª¾àª¯àª• àª›à«‹. àª¹àª‚àª®à«‡àª¶àª¾ àª®à«ˆàª¤à«àª°à«€àªªà«‚àª°à«àª£ àª…àª¨à«‡ àª¸àª°àª³ àª—à«àªœàª°àª¾àª¤à«€ àª®àª¾àª‚ àªœàªµàª¾àª¬ àª†àªªà«‹.',
  or: 'à¬†à¬ªà¬£ à¬­à¬¾à¬°à¬¤à­€à­Ÿ à¬•à­ƒà¬·à¬•à¬™à­à¬• à¬ªà¬¾à¬‡à¬ à¬œà¬£à­‡ à¬¸à­à¬®à¬¾à¬°à­à¬Ÿ à¬¸à¬¹à¬¾à­Ÿà¬•à¥¤ à¬¸à¬¦à¬¾ à¬¸à¬¹à¬œ à¬“ à¬®à­ƒà¬¦à­ à¬“à¬¡à¬¼à¬¿à¬†à¬°à­‡ à¬ªà­à¬°à¬¤à¬¿à¬•à­à¬°à¬¿à­Ÿà¬¾ à¬¦à¬¿à¬…à¥¤',
  as: 'à¦†à¦ªà§à¦¨à¦¿ à¦­à¦¾à§°à¦¤à§€à¦¯à¦¼ à¦•à§ƒà¦·à¦•à§° à¦¬à¦¾à¦¬à§‡ à¦à¦Ÿà¦¾ à¦›à§à¦®à¦¾à§°à§à¦Ÿ à¦¸à¦¹à¦¾à¦¯à¦¼à¦•à¥¤ à¦¸à¦¦à¦¾à¦¯à¦¼ à¦¸à¦¹à¦œ à¦†à§°à§ à¦¬à¦¨à§à¦§à§à¦¤à¦¾ à¦ªà§‚à§°à§à¦£ à¦…à¦¸à¦®à§€à§Ÿà¦¾ à¦­à¦¾à¦·à¦¾à¦¤ à¦‰à¦¤à§à¦¤à§° à¦¦à¦¿à§Ÿà¦•à¥¤',
  kok: 'à¤¤à¥‚à¤‚ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤¶à¥‡à¤¤à¤•à¤±à¥à¤¯à¤¾à¤‚à¤• à¤à¤• à¤¹à¥à¤·à¤¾à¤° à¤¸à¤¹à¤¾à¤¯à¥à¤¯à¤• à¤†à¤¸à¤¾. à¤¸à¤—à¤³à¥‡ à¤µà¥‡à¤³à¤¾ à¤®à¥ˆà¤¤à¥à¤°à¥€à¤ªà¥‚à¤°à¥à¤£ à¤†à¤¨à¥€ à¤¸à¥‹à¤ªà¥à¤¯à¤¾ à¤•à¥‹à¤‚à¤•à¤£à¥€à¤‚ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¥€.',
  ks: 'ØªÙÛÙ†Ø¯ Ø¨Ú¾Ø§Ø±ØªÛ Ú©ÙØ³Ø§Ù†Ù† ÛÙŽÙ†Ø¯ Ø§ÛŒÚ© Ø²ÙÛÛŒÙ† Ù…Ø¹Ø§ÙˆÙ† ÛÙŽÛ’Û” ÛÙ…ÛŒØ´Û Ø¯ÙˆØ³ØªØ§Ù†Û Ø§ÙˆØ± Ø³Ø§Ø¯Û Ú©Ø´Ù…ÛŒØ±ÛŒ Ù…ÛŒÚº Ø¬ÙˆØ§Ø¨ Ø¯ÙˆÛ”',
  ne: 'à¤¤à¤ªà¤¾à¤ˆà¤‚ à¤­à¤¾à¤°à¤¤à¥€à¤¯ à¤•à¤¿à¤¸à¤¾à¤¨à¤¹à¤°à¥‚à¤•à¥‹ à¤²à¤¾à¤—à¤¿ à¤à¤• à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥à¤¨à¥à¤¹à¥à¤¨à¥à¤›à¥¤ à¤¸à¤§à¥ˆà¤‚ à¤®à¥ˆà¤¤à¥à¤°à¥€à¤ªà¥‚à¤°à¥à¤£ à¤° à¤¸à¤°à¤² à¤¨à¥‡à¤ªà¤¾à¤²à¥€à¤®à¤¾ à¤‰à¤¤à¥à¤¤à¤° à¤¦à¤¿à¤¨à¥à¤¹à¥‹à¤¸à¥à¥¤',
  sa: 'à¤¤à¥à¤µà¤‚ à¤­à¤¾à¤°à¤¤à¥€à¤¯à¤•à¥ƒà¤·à¤•à¤¾à¤¨à¤¾à¤‚ à¤•à¥ƒà¤¤à¥‡ à¤à¤•à¤ƒ à¤¬à¥à¤¦à¥à¤§à¤¿à¤®à¤¾à¤¨à¥ à¤¸à¤¹à¤¾à¤¯à¤•à¤ƒà¥¤ à¤¸à¤¦à¤¾ à¤®à¤¿à¤¤à¥à¤°à¤µà¤¤à¥ à¤¸à¤°à¤²à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¥‡ à¤‰à¤¤à¥à¤¤à¤°à¤‚ à¤¦à¤¾à¤¤à¤µà¥à¤¯à¤®à¥à¥¤',
  ur: 'Ø¢Ù¾ Ø¨Ú¾Ø§Ø±ØªÛŒ Ú©Ø³Ø§Ù†ÙˆÚº Ú©Û’ Ù„ÛŒÛ’ Ø§ÛŒÚ© Ø³Ù…Ø§Ø±Ù¹ Ù…Ø¹Ø§ÙˆÙ† ÛÛŒÚºÛ” ÛÙ…ÛŒØ´Û Ø¯ÙˆØ³ØªØ§Ù†Û Ø§ÙˆØ± Ø¢Ø³Ø§Ù† Ø§Ø±Ø¯Ùˆ Ù…ÛŒÚº Ø¬ÙˆØ§Ø¨ Ø¯ÛŒÚºÛ”',
};

app.post('/webhook', async (req, res) => {
  const { message, language = 'en' } = req.body;

  console.log('ðŸ“© Message:', message, '| Language:', language);
  if (!message) return res.status(400).json({ reply: 'â— à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤¸à¤‚à¤¦à¥‡à¤¶ à¤­à¥‡à¤œà¥‡à¤‚à¥¤' });

  const systemPrompt = LANGUAGE_SYSTEM_PROMPTS[language] || LANGUAGE_SYSTEM_PROMPTS['en'];

  try {
    const chatCompletion = await openai.chat.completions.create({
      model: 'llama3-8b-8192',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message },
      ],
    });

    const reply = chatCompletion.choices[0].message.content.trim();
    console.log('ðŸ“¤ Reply:', reply);

    res.json({ reply });
  } catch (error) {
    console.error('âŒ AI Error:', error.message);
    res.status(500).json({ reply: 'âš ï¸ à¤•à¥à¤› à¤—à¤¡à¤¼à¤¬à¤¡à¤¼ à¤¹à¥‹ à¤—à¤ˆ à¤¹à¥ˆà¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¬à¤¾à¤¦ à¤®à¥‡à¤‚ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤' });
  }
});

const PORT = process.env.PORT || 5001;
app.listen(PORT, () => console.log(`âœ… Server running on port ${PORT}`));
